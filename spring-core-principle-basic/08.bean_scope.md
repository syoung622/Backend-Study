### 빈 스코프

- `스프링 빈`: 스프링 컨테이너에서 관리하는 자바 객체
- `스코프`: 존재할 수 있는 범위

##### 웹 관련 스코프

- `request`: 웹 요청이 들어오고 나갈 때까지 유지되는 스코프
- `session`: 웹 세션이 생성되고 종료될 때까지 유지되는 스코프
- `application`: 웹의 서블릿 컨텍스트와 같은 범위로 유지되는 스코프

##### 빈 스코프 사용 방법

- 컴포넌트 스캔 자동 등록
- 수동 등록


#### 프로토타입 스코프

- 싱글톤 스코프의 빈 요청: 모두 동일한 스프링 빈 반환
- 프로토타입 스코프의 빈 요청
  - 클라이언트에서 프로토타입 스코프의 스프링 빈을 스프링 컨테이너에 요청
  - 스프링 컨테이너는 해당 시점에 프로토타입 빈을 생성, 의존관계 주입
  - 생성한 프로토타입 빈을 클라이언트에 반환

> 프로토타입은 싱글톤 스프링 빈과 다르게 빈 생성, 의존관계 주입, 초기화까지만 진행.
> 스프링 빈을 클라이언트에 반환한 이후에는 관리하지 않으므로 소멸 메서드와 같은 것들은 모두 클라이언트가 자체적으로 관리


#### 프로토타입 스코프 - 싱글톤 빈과 함께 사용시 문제점

- 싱글톤 스프링 빈 내부에 의존관계로 주입되는 스프링 빈이 프로토타입인 경우
  - 싱글톤 빈에서 프로토타입 빈을 사용
  - 싱글톤 빈은 생성 시점에만 의존관계를 주입받기 때문에 프로토타입 빈이 새로 생성되지만 싱글톤 빈과 함께 계속 유지되는 것이 문제
  - 프로토타입 빈을 주입 시점에만 새로 생성하는 것이 아닌 사용할 때마다 새로 생성해서 사용하는 것이 목적일 것


#### 프로토타입 스코프 - 싱글톤 빈과 함께 사용시 Provider로 문제 해결

- 스프링 컨테이너에 요청
  - ApplicationContext 전체를 주입받게 되면 스프링 컨테이너에 종속적
  - 단위테스트 어려움
- `ObjectFactory`, `ObjectProvider`
  - `ObjectFactory`
    - 지정한 빈을 컨테이너에서 대신 찾아줌.
    - getObject()만 제공하는 FunctionalInterface
  - `ObjectProvider`
    - `ObjectFactory`에서 편의기능들(Optional, Stream) 추가해서 만들어진 객체
  - 스프링에 종속적이지만 기능이 단순해서 단위테스트 및 Mock을 이용한 테스트 더블을 하기 쉬움.
- JSR-330 Provider
  - 새로운 프로토타입 빈 생성 확인 가능
  - getObject대신 get메서드로 DL 가능
  - 자바 표준, 기능 단순하여 단위테스트와 테스트 더블 가능
    - 다른 컨테이너에서도 사용 가능
  - 별도의 라이브러리 필요

##### 프로토타입 빈을 언제 사용해야 하는가?

- 여러 인스턴스를 검색해야 하는 경우
- 인스턴스를 지연 혹은 선택적으로 찾아야하는 경우
- 순환 종속성을 깨기 위해
- 스코프에 포함된 인스턴스로부터 더 작은 범위의 인스턴스를 찾아 추상화하기 위해

#### 웹 스코프

- 웹 환경에서만 동작하는 스코프
- 스프링이 해당 스코프의 종료시점까지 관리, 종료 메서드 호출
- 종류
  - `request`: HTTP 요청 들어오고 나갈 때까지 유지되는 스코프, 각 요청마다 별도의 빈 인스턴스가 생성 및 관리
  - `session`: HTTP Session과 동일한 생명주기 가짐
  - `application`: 서블릿 컨텍스트와 동일한 생명주기 가지는 스코프
  - `websocket`: 웹소켓과 동일한 생명주기 가지는 스코프


- 스프링 빈의 생성시점이 구동시점이 아닌 지연된 시점(request 요청 시점)이 되는 문제가 발생


#### 스코프와 Provider, 프록시

스프링 빈의 생성시점이 구동시점이 아닌 지연된 시점(request 요청 시점)이 되는 경우의 해결책

- Provider
- 프록시 활용
  - 스코프의 속성을 활용하여 빈을 프록시 객체로 지정
    - 적용 대상
      - 클래스: TARGET_CLASS
      - 인터페이스: INTERFACES
    - 가짜 프록시 빈을 생성, 의존관계 주입
    - 빈이 실제로 사용될 때 프록시 빈에서 실제 빈을 가져와 사용
    - 컨트롤러, 서비스 코드를 이전상태로 돌린 후 재실행하여도 정상 작동
  

##### 웹 스코프와 프록시의 동작 원리

- CGLIB라는 라이브러리로 클래스를 상속받은 가짜 프록시 객체를 만들어 의존관계 주입
- 가짜 프록시 객체는 요청이 오면 그 시점에 내부에서 진짜 빈을 요청
- 가짜 프록시 객체는 실제 request scope와는 관계 없음. 내부에 위임로직만 있고 싱글톤처럼 동작

##### 특징
- provider, 프록시 모든 핵심은 진짜 객체 조회를 필요한 시점까지 지연처리한다는 점
- 어노테이션 설정만으로 원본 객체를 프록시 객체로 대체 가능 -> 다형성, DI의 장점
- 웹 스코프가 아니라도 프록시 사용 가능
- 특별한 scope는 최소화하여 사용